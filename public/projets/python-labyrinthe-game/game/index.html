<html lang="en-us"><script src="https://pygame-web.github.io/cdn/0.9.3/pythons.js" type=module id="site" data-python="python3.12" data-LINES=42 data-COLUMNS=132 data-os="vtx,snd,gui" async defer><!--

print("""
Loading mon_projet_labyrinthe from mon_projet_labyrinthe.apk
    Pygbag Version : 0.9.3
    Template Version : 0.9.3
    Python  : 3.12
    CDN URL : https://pygame-web.github.io/cdn/0.9.3/
    Screen  : 1280x720
    Title   : mon_projet_labyrinthe
    Folder  : mon_projet_labyrinthe
    Authors : pgw
    SPDX-License-Identifier: cookiecutter.spdx

""")

import sys
import asyncio
import platform
import json
from pathlib import Path

# do not rename
async def custom_site():
    import embed
    platform.document.body.style.background = "#0d1117"

    platform.window.canvas.style.visibility = "visible"


    bundle = "mon_projet_labyrinthe"

    # the C or js loader could do that but be explicit.
    appdir = Path(f"/data/data/{bundle}") # /data/data/mon_projet_labyrinthe
    appdir.mkdir()


    # unpack filesystem from compressed archive into work dir
    import zipfile
    async with platform.fopen("/game/mon_projet_labyrinthe.apk", "rb") as archive:
        with zipfile.ZipFile(archive) as zip_ref:
            zip_ref.extractall(appdir.as_posix())

    # preloader will change to work dir and prepend it to sys.path
    platform.run_main(PyConfig, loaderhome= appdir / "assets", loadermain=None)


    # wait preloading complete : that includes images and wasm compilation of bundled modules
    while embed.counter()<0:
        await asyncio.sleep(.1)

    main = appdir / "assets" / "main.py"

    # TODO: test for window.webkitAudioContext and block aio loop until gesture if accessing media manager play
    # before a gesture is recorded ( touch or click )

    # start async top level machinery if not started and add a console in any case if requested.
    await TopLevel_async_handler.start_toplevel(platform.shell, console=window.python.config.debug)

    # now that apk is mounted we have access to font cache
    # but we need to fill __file__/__name__ that are not yet set
    __import__(__name__).__file__ = main


    def ui_callback(pkg):
        platform.window.infobox.innerText = f"installing {pkg}"

    await shell.source(main, callback=ui_callback)

    # if you don't reach that step
    # your main.py has an infinite sync loop somewhere !

    platform.window.infobox.style.display = "none"
    platform.window.config.gui_divider = 1
    platform.window.window_resize()
    print("default.tmpl: done")

    shell.interactive()
    platform.window.hideSentinel()

asyncio.run( custom_site() )










# BEGIN BLOCK
#
# now this is the html part you can (and should) customize
# It is not mandatory : pygame-script when it reads the first line (also called
# shebang ) of above code create absolute minimal widget set
# required for running with default rules
#
# do not alter that comment block it is separating python code from html code
# =============================================================================
# --></script><head><!--
//=============================================================================
//
//
//
//
//
//
//

    {%- if cookiecutter.comment != "" -%}
{{cookiecutter.comment}}
    {% endif %}

--><script type="application/javascript">
// END BLOCK



// this dict is available under PyConfig.config from __main__

config = {
    xtermjs : "1" ,
    _sdl2 : "canvas",
    user_canvas : 0,
    user_canvas_managed : 0,
    gui_divider : 2,
    ume_block : 1,
    can_close : 0,
    archive : "mon_projet_labyrinthe",
    gui_debug : 2,
    cdn : "https://pygame-web.github.io/cdn/0.9.3/",
    autorun : 0,
    PYBUILD : "3.12",
    fb_ar   :  1.77,
    fb_width : "1280",
    fb_height : "720"
}

function show_infobox() {
    infobox.style.display = "block";

    // Measure box
    const w = infobox.offsetWidth;
    const h = infobox.offsetHeight;

    // Center in viewport
    const left = (window.innerWidth - w) / 2;
    const top = (window.innerHeight - h) / 2;

    infobox.style.left = left + "px";
    infobox.style.top = top + "px";
}

</script>

    <title>mon_projet_labyrinthe</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="height=device-height, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes"/>


    <link rel="icon" type="image/png" href="favicon.png" sizes="16x16">

    <style>
        /* High-Tech Glassmorphism & Neon Loader */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0d1117;
            color: #e6edf3;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #transfer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            background-color: #0d1117;
            transition: opacity 0.8s ease-out;
        }

        .loader-container {
            background: rgba(30, 41, 59, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(56, 189, 248, 0.3);
            box-shadow:
                0 0 60px rgba(56, 189, 248, 0.2),
                0 0 20px rgba(56, 189, 248, 0.1),
                inset 0 0 20px rgba(56, 189, 248, 0.05);
            padding: 3rem 4rem;
            min-width: 500px;
            max-width: 90%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .loader-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00d9ff, #0066ff, #00d9ff);
            border-radius: 26px;
            z-index: -1;
            filter: blur(10px);
            opacity: 0.4;
        }

        .loader-title {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
            color: #38bdf8;
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
        }

        .loader-subtitle {
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #94a3b8;
            margin-bottom: 2.5rem;
        }

        .progress-wrapper {
            width: 100%;
            margin-bottom: 2rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #cbd5e1;
        }

        #progress-bar-container {
            height: 12px;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid rgba(56, 189, 248, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #00d9ff, #0066ff, #00d9ff);
            border-radius: 6px;
            box-shadow:
                0 0 15px rgba(0, 217, 255, 0.7),
                0 0 5px rgba(0, 217, 255, 0.9);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #status {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            color: #e2e8f0;
            margin-top: 1.5rem;
            min-height: 1.5em;
            text-transform: uppercase;
        }

        .tech-messages {
            margin-top: 2rem;
            font-size: 0.85rem;
            color: #64748b;
            letter-spacing: 0.05em;
            line-height: 1.5;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Canvas styles (unchanged) */
        canvas.emscripten {
            border: 0px none;
            background-color: transparent;
            width: 100%;
            height: 100%;
            z-index: 5;
            padding: 0;
            margin: 0 auto;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }

        /* Other existing styles kept */
        #infobox {
            position: fixed;
            background: green;
            color: blue;
            font-weight: bold;
            padding: 12px 24px;
            z-index: 999999;
        }
        div.emscripten { text-align: center; }
        div.emscripten_border { border: 1px solid black; }
        div.thick_border { border: 4px solid black; }

        .topright{
           position:absolute;
           top:0px;
           right:0px;
        }

        .bottomright {
            position:absolute;
            top: 40%;
            right: 0px;
        }

        .center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trinfo{
           position: relative;
           right: 0px;
           border: 1px solid black;
        }

        .framed{
           position: relative;
           top: 150px;
           right: 10px;
           border: 1px solid black;
        }
    </style>

    <script>
/*
        if (navigator.serviceWorker)
            navigator.serviceWorker.register("https://pygame-web.github.io/cdn/0.9.3/pygbag0.9.3.js")
        else
            console.warn("Service workers not supported")
*/
    </script>

    <script src="https://pygame-web.github.io/cdn/0.9.3//browserfs.min.js"></script>

</head>

<body>

    <div id="transfer">
        <div class="loader-container">
            <div class="loader-title">SYSTEM INITIALIZATION</div>
            <div class="loader-subtitle">MON_PROJET_LABYRINTHE // PYGBAG 0.9.3</div>
            
            <div class="progress-wrapper">
                <div class="progress-label">
                    <span>PROGRESS</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
            </div>

            <div id="status">Initialisation du noyau WASM...</div>

            <div class="tech-messages">
                <div>› Chargement des ressources graphiques...</div>
                <div>› Compilation des modules Python...</div>
                <div>› Préparation de l'environnement d'exécution...</div>
            </div>
        </div>
    </div>



    <canvas class="emscripten" id="canvas"
width="1px"
height="1px"
    oncontextmenu="event.preventDefault()" tabindex=1>
    </canvas>

    <canvas class="emscripten" id="canvas3d"
width="1280px"
height="720px"
    oncontextmenu="event.preventDefault()" tabindex=1 hidden>
    </canvas>

    <div id="infobox">Loading, please wait ...</div>

    <div id=html></div>

    <div id=crt  class=bottomright >

        <div id="system" hidden>
            <div class="button-container">
                <button id="aiostop" disabled>AIO ⏏︎</button>
                <button id="aiopaused_true" disabled>AIO ■</button>
                <button id="aiopaused_false" disabled>AIO ▶</button>
                <button id="pygame_mixer_music_pause" disabled>Music ■</button>
            </div>

            <div class="button-container">
                <div id=load_min>min</div>
                <div id=load_avg>avg</div>
                <div id=load_max>max</div>
              <button id="load_rst" disabled>RESET</button>
            </div>

            <div id="level">(battery level unknown)</div>
            <div id="stateBattery">(charging state unknown)</div>

        </div>

        <div id=box class="emscripten_border" hidden=true>

            <div id="info" class="trinfo"></div>

            <iframe id="iframe" class="framed" name="iframe"
width="470px" height="90%"
allowtransparency="true"
style="z-index: 10;"
style="background: #FFFFFF;"
frameborder="1"
                allowfullscreen="true"
                webkitallowfullscreen="true"
                msallowfullscreen="true"
                mozallowfullscreen="true"
                sandbox="allow-same-origin allow-top-navigation allow-scripts allow-pointer-lock"
                allow="autoplay; fullscreen *; geolocation; microphone; camera; midi; monetization; xr-spatial-tracking; gamepad; gyroscope; accelerometer; xr; cross-origin-isolated"
                src="https://pygame-web.github.io/cdn/0.9.3/empty.html"
                scrolling="yes">
            </iframe>
        </div>

    </div>


    <div id="dlg" hidden>
        <input type="file" id="dlg_multifile" multiple accept="image/*">
        <label for="dlg_multifile">Select files</label>
    </div>

    <div id="pyconsole">
        <div id="terminal" tabIndex=1 align="left"></div>
    </div>

    <script type="application/javascript">

    globalThis.__canvas_resized = (self, ecw, ech) => {
        console.warn("TODO: panda3d canvas monitor", self, ecw, ech)
    }

    async function custom_onload(debug_hidden) {
        // this is called before anything python is loaded
        // make your js customization here
        console.log(__FILE__, "custom_onload")

        pyconsole.hidden = debug_hidden
        system.hidden = debug_hidden
        transfer.hidden = debug_hidden
        info.hidden = debug_hidden
        box.hidden =  debug_hidden

        show_infobox()
    }

    function custom_prerun(){
        // no python main and no (MEMFS + VFS) yet.
        console.log(__FILE__, "custom_prerun")

    }

    function custom_postrun(){
        // python main and no VFS filesystem yet.
        console.log(__FILE__, "custom_postrun")

    }

    function debug() {
        // allow to gain access to dev tools from js console
        // but only on desktop. difficult to reach when in iframe
        python.config.debug = true
        custom_onload(false)
        Module.PyRun_SimpleString("shell.uptime()")
        window_resize()
    }

    function info_inline(data){
        document.getElementById("info").innerHTML = data
    }

    function info_online(url) {
        // display info about current APK
        fetch( url /*, options */)
            .then((response) => response.text())
            .then((html) => {
                info_inline(html);
        })
        .catch((error) => {
            console.warn(error);
        });
    }

    function frame_online(url) {
        window.frames["iframe"].location = url;
    }

    // High-Tech Loader: Override Module.setStatus safely
    (function() {
        const statusMessages = [
            "Initialisation du noyau WASM...",
            "Optimisation des ressources graphiques...",
            "Chargement des modules Python...",
            "Compilation des shaders...",
            "Préparation de l'environnement d'exécution...",
            "Vérification des dépendances système...",
            "Configuration des canaux audio...",
            "Chargement des textures...",
            "Finalisation de l'initialisation..."
        ];
        let messageIndex = 0;

        function safeSetStatus(text) {
            console.log("[Loader] ", text);
            
            // If text is empty, loading is complete (download finished)
            // Do NOT hide the loader, just update status to indicate engine start
            if (!text) {
                const statusEl = document.getElementById('status');
                if (statusEl) {
                    statusEl.textContent = "Démarrage du moteur graphique...";
                }
                const progressBar = document.getElementById('progress-bar');
                const progressPercent = document.getElementById('progress-percent');
                if (progressBar) progressBar.style.width = '100%';
                if (progressPercent) progressPercent.textContent = '100%';
                // Keep loader visible, hideSentinel() will be called from Python later
                return;
            }

            // Parse progress from text like "X/Y"
            let percent = 0;
            const match = text.match(/(\d+)\s*\/\s*(\d+)/);
            if (match) {
                const current = parseInt(match[1]);
                const total = parseInt(match[2]);
                percent = total > 0 ? Math.round((current / total) * 100) : 0;
                const progressBar = document.getElementById('progress-bar');
                const progressPercent = document.getElementById('progress-percent');
                if (progressBar) progressBar.style.width = percent + '%';
                if (progressPercent) progressPercent.textContent = percent + '%';
            }

            // Update status text with rotating messages
            const statusEl = document.getElementById('status');
            if (statusEl) {
                if (percent % 20 === 0 && messageIndex < statusMessages.length - 1) {
                    messageIndex++;
                }
                statusEl.textContent = statusMessages[messageIndex];
            }
        }

        // Global function to hide the loader, called from Python when game is ready
        window.hideSentinel = function() {
            const transfer = document.getElementById('transfer');
            if (transfer) {
                transfer.style.opacity = '0';
                setTimeout(() => {
                    transfer.style.display = 'none';
                }, 800);
            }
        };

        // Wait for Module to be defined, then override setStatus
        function waitForModule() {
            if (typeof Module !== 'undefined' && Module.setStatus) {
                const originalSetStatus = Module.setStatus;
                Module.setStatus = function(text) {
                    safeSetStatus(text);
                    originalSetStatus.call(this, text);
                };
                console.log('[Loader] Module.setStatus overridden');
            } else {
                setTimeout(waitForModule, 100);
            }
        }
        waitForModule();
    })();

    </script>

</body>
</html>
